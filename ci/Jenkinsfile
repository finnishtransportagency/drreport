import groovy.json.JsonOutput

def get_environment() {
    if (BRANCH_NAME.equals("develop")) { return "dev" }
    if (BRANCH_NAME.equals("master")) { return "prod" }
    if (BRANCH_NAME.startsWith("release-")) { return "stg" }
    if (BRANCH_NAME.equals("jenkinsfile-temp")) { return "dev" } // temp branch
    return ""
}
def get_version_suffix() {
    if (get_environment().equals("dev")) { return "-SNAPSHOT" }
    if (get_environment().equals("prod")) { return "" }
    return "-${get_environment().toUpperCase()}-SNAPSHOT"
}
def get_ansible_limit() {
    if (BRANCH_NAME.equals("develop")) { return ["livisovt136l"] }
    if (BRANCH_NAME.equals("master")) { return ["liviptpapp01l","liviptpapp02l"] }
    if (BRANCH_NAME.startsWith("release-")) { return ["liviptpappt01l","liviptpappt02l"] }
    if (BRANCH_NAME.equals("jenkinsfile-temp")) { return ["livisovt136l"] } // temp branch
    return ""
}
def notify(message,color) {
    slackSend(color: "${color}", message: "${JOB_NAME} - <${RUN_DISPLAY_URL}|${BUILD_DISPLAY_NAME}> - ${message}")
}
pipeline {
    agent any
    environment {
        NOTIFY_SLACK_SUBJECT = "${JOB_NAME} - <${RUN_DISPLAY_URL}|${BUILD_DISPLAY_NAME}>"
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: "25"))
        disableConcurrentBuilds()
    }
    stages {
        stage("Setup") {
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                script {

                    def pom = readMavenPom()

                    def deploy_target = get_environment()

                    def ansible_inventory = '/data1/ansible/inventory'
                    def ansible_playbook = "/data1/ansible/ptpapp-${get_environment()?.trim()}.yml"
                    def ansible_limit = get_ansible_limit().join(',')
                    def ansible_vault_pass = 'vaultpass-ptp'
                    def ansible_credentials_id = 'a98f88e8-88ea-4f5e-bfe4-972725d7b72d'
                    def repository_url = "http://livibuild03.vally.local/nexus/repository/ptp"

                    def deploy = [
                        artifact_id: pom.artifactId,
                        extension: pom.packaging,
                        group_id: pom.groupId,
                        repository_url: repository_url,
                        version: "${pom.version}${get_version_suffix()}"
                    ]
                    def drreport_deploy=JsonOutput.toJson(deploy)
                    def ansible_extravars = "-e drreport_deploy='${drreport_deploy}'"
                    def filename = "target/${deploy.artifact_id}-${deploy.version}.${deploy.extension}"

                    STAGE_ACK_PARAMETERS = [
                        choice(choices: deploy_target, description: "Deploy target.", name: "deploy_target"),
                        choice(choices: deploy.artifact_id, description: "Artifact ID", name: "artifact_id"),
                        choice(choices: deploy.version, description: "Artifact version", name: "artifact_version"),
                        choice(choices: deploy.group_id, description: "Group ID", name: "group_id")
                    ]

                    STAGE_PREPARE_CMD = [
                        "cd src/main/resources/static",
                        "npm install",
                        "npm run build",
                        "sleep 30" // watchify doesn't work without this
                    ].join(" && ")

                    STAGE_BUILD_CMD = [
                        [
                            "mvn",
                            "install:install-file",
                            "-Dfile=ojdbc14-10.2.0.4.0.jar",
                            "-DgroupId=com.oracle",
                            "-DartifactId=ojdbc14",
                            "-Dversion=10.2.0.4.0",
                            "-Dpackaging=jar"
                        ].join(" "),
                        [
                            "mvn",
                            "versions:set",
                            "-DnewVersion=${deploy.artifact_version}",
                            "--batch-mode"
                        ].join(" "),
                        [
                            "mvn",
                            "clean",
                            "install",
                            "--batch-mode"
                        ].join(" ")
                    ].join(" && ")

                    STAGE_CONFIRM_TEXT = "Create release ${deploy.group_id}:${deploy.artifact_id}@${deploy.artifact_version} and deploy to ${deploy_target}?"

                    STAGE_PUBLISH_CMD = [
                        "mvn",
                        "deploy:deploy-file",
                        "-Dfile=${filename}",
                        "-DpomFile=pom.xml",
                        "-DrepositoryId=nexus3",
                        "-Durl=${repository_url}",
                        "--batch-mode"
                    ].join(" ")

                    STAGE_DEPLOY_PLAYBOOK = [
                        inventory: ansible_inventory,
                        playbook: ansible_playbook,
                        limit: ansible_limit,
                        become: true,
                        extras: ansible_extravars,
                        vaultCredentialsId: ansible_vault_pass,
                        credentialsId: ansible_credentials_id
                    ]
                }
            }
        }
        stage("Ack") {
            agent none
            options {
                timeout(time: 5, unit: "MINUTES")
            }
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                slackSend(
                    color: "warning",
                    message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} requires acknowledgement! Visit <${RUN_DISPLAY_URL}|here> and verify!"
                )
                input(
                    message: "Proceed with following settings?",
                    parameters: STAGE_ACK_PARAMETERS
                )
            }
            post {
                aborted {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} aborted because acknowledgement timeout exceeded or user action!"
                    )
                }
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} aborted! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Docker") {
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                sh "cp /data1/ci/{maven,node,python}/* ci/confs/"
                script {
                    def jenkins_uid = sh(returnStdout: true, script: "id -u").trim()
                    def build_args = [
                        "--build-arg http_proxy=${http_proxy}",
                        "--build-arg https_proxy=${http_proxy}",
                        "--build-arg no_proxy=${no_proxy}",
                        "--build-arg JENKINS_UID=${jenkins_uid}"
                    ].join(" ")
                    docker.build(
                        "dr-maven",
                        "${build_args} -f ci/Dockerfile.maven ci"
                    )
                    docker.build(
                        "dr-node",
                        "${build_args} -f ci/Dockerfile.node ci"
                    )
                    docker.build(
                        "dr-python",
                        "${build_args} -f ci/Dockerfile.python ci"
                    )
                }
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Prepare") {
            agent {
                docker {
                    image "dr-node"
                    reuseNode true
                }
            }
            when {
                beforeAgent true
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                sh STAGE_PREPARE_CMD
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Build") {
            agent {
                docker {
                    image "dr-maven"
                    reuseNode true
                }
            }
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                sh STAGE_BUILD_CMD
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Confirm") {
            agent none
            options {
                timeout(time: 5, unit: "MINUTES")
            }
            when {
                beforeAgent true
                expression {
                    get_environment()?.trim()
                }
                not {
                    branch "develop"
                }
            }
            steps {
                slackSend(
                    color: "warning",
                    message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} requires confirmation! Visit <${RUN_DISPLAY_URL}|here> and verify!"
                )
                input STAGE_CONFIRM_TEXT
            }
            post {
                aborted {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} aborted because confirmation timeout exceeded or user action!"
                    )
                }
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Publish") {
            agent {
                docker {
                    image "dr-maven"
                    reuseNode true
                }
            }
            when {
                beforeAgent true
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                sh STAGE_PUBLISH_CMD
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Deploy") {
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                ansiblePlaybook(STAGE_DEPLOY_PLAYBOOK)
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT}\nStage ${STAGE_NAME} failure! Check <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
        stage("Test") {
            agent {
                docker {
                    image "dr-python"
                    reuseNode true
                }
            }
            when {
                expression {
                    get_environment()?.trim()
                }
            }
            steps {
                sh "pip --version"
            }
            post {
                failure {
                    slackSend(
                        color: "danger",
                        message: "${NOTIFY_SLACK_SUBJECT} - Stage ${STAGE_NAME} failure!\nCheck <${BUILD_URL}console|console>!"
                    )
                }
                unstable {
                    slackSend(
                        color: "warning",
                        message: "${NOTIFY_SLACK_SUBJECT} - Stage ${STAGE_NAME} failure!\nCheck <${BUILD_URL}console|console>!"
                    )
                }
            }
        }
    }
    post {
        always {
            slackSend(
                color: currentBuild.currentResult.equals("SUCCESS") ? "good" : "danger",
                message: "${NOTIFY_SLACK_SUBJECT}\nJob ${currentBuild.currentResult}! More info <${BUILD_URL}|here>."
            )
            deleteDir()
        }
    }
}
